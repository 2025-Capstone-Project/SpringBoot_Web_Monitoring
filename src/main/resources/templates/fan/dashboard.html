<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/default :: layout(~{::title}, ~{::section}) }">
<head>
    <title>Fan Control Dashboard</title>
</head>
<body>
<section>
    <div class="card shadow-sm p-4">
        <h2 class="text-center mb-4">Fan Control Dashboard</h2>
        <div class="row g-3 kpi-grid">
            <div class="col-6 col-md-3">
                <div class="card kpi">
                    <div class="card-body text-center">
                        <div class="kpi-title">CPU Temperature</div>
                        <div class="kpi-value" id="cpuTemp">-- °C</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card kpi">
                    <div class="card-body text-center">
                        <div class="kpi-title">GPU Temperature</div>
                        <div class="kpi-value" id="gpuTemp">-- °C</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card kpi">
                    <div class="card-body text-center">
                        <div class="kpi-title">Model Result</div>
                        <div class="kpi-value" id="modelResult">--</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card kpi">
                    <div class="card-body text-center">
                        <div class="kpi-title">Set Fan PWM</div>
                        <div class="kpi-value" id="setPwm">-- %</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card kpi">
                    <div class="card-body text-center">
                        <div class="kpi-title">Actual Fan PWM</div>
                        <div class="kpi-value" id="actualPwm">-- %</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm p-4 mt-4">
        <h4 class="mb-3 text-center">Fan Control</h4>

        <!-- 상단 행: 왼쪽 드롭다운, 오른쪽 라디오 그룹 -->
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-6">
                <label for="controlMode" class="form-label mb-1">Control Mode:</label>
                <select id="controlMode" class="form-select"
                        th:disabled="${!isAdmin}"
                        th:title="${!isAdmin} ? '관리자만 변경할 수 있습니다' : '모드 선택'">
                    <option value="AUTOMATIC" th:selected="${currentMode} == 'AUTOMATIC'">Automatic</option>
                    <option value="MANUAL" th:selected="${currentMode} == 'MANUAL'">Manual</option>
                </select>
                <div class="form-text" th:if="${!isAdmin}">수동 제어는 관리자만 사용할 수 있습니다.</div>
                <div id="serverModeBadge" class="form-text"></div>
            </div>
            <div class="col-12 col-md-6" id="dimensionGroup">
                <div class="form-label mb-1">Control Target:</div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="dimension" id="dimSpeed" value="SPEED" checked>
                    <label class="form-check-label" for="dimSpeed">속도</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="dimension" id="dimTemp" value="TEMP">
                    <label class="form-check-label" for="dimTemp">온도</label>
                </div>
            </div>
        </div>

        <!-- 하단: 단일 위치에 두 컨트롤 영역을 토글 표시 -->
        <div class="row g-3 mt-1">
            <!-- 속도 제어 (Manual일 때만, 라디오=속도일 때) -->
            <div class="col-12" id="manualControlsSpeed" th:style="${currentMode} == 'MANUAL' ? '' : 'display:none;'">
                <fieldset th:disabled="${!isAdmin}">
                    <label for="pwmRange" class="form-label mb-1">Set PWM: <span id="pwmLabel" th:text="${currentSetPwm} + '%'">0%</span></label>
                    <input type="range" class="form-range" min="0" max="100" step="1" id="pwmRange" th:value="${currentSetPwm}"/>
                    <input type="number" class="form-control mt-2" id="pwmNumber" min="0" max="100" step="1" th:value="${currentSetPwm}"/>
                    <button id="applyBtn" class="btn btn-primary mt-2">Apply</button>
                </fieldset>
            </div>

            <!-- 온도 임계치 제어 (Manual + 라디오=온도) -->
            <div class="col-12" id="manualControlsTemp" style="display:none;">
                <fieldset th:disabled="${!isAdmin}">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label for="cpuThreshold" class="form-label">CPU 비정상 임계 (°C)</label>
                            <input type="range" class="form-range" min="30" max="100" step="1" id="cpuThreshold" th:value="${cpuThreshold}">
                            <input type="number" class="form-control" id="cpuThresholdNum" min="30" max="100" step="1" th:value="${cpuThreshold}">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="gpuThreshold" class="form-label">GPU 비정상 임계 (°C)</label>
                            <input type="range" class="form-range" min="30" max="100" step="1" id="gpuThreshold" th:value="${gpuThreshold}">
                            <input type="number" class="form-control" id="gpuThresholdNum" min="30" max="100" step="1" th:value="${gpuThreshold}">
                        </div>
                    </div>
                    <button id="applyTempBtn" class="btn btn-warning mt-2">Apply Thresholds</button>
                    <div class="form-text" th:if="${!isAdmin}">임계치는 관리자만 수정할 수 있습니다.</div>
                </fieldset>
            </div>
        </div>
    </div>

    <!-- 페이지 전용 스크립트: 레이아웃에 포함되도록 section 내부로 이동 -->
    <script th:inline="javascript">
      window.__initialMode = [[${currentMode}]];
      window.__initialSetPwm = [[${currentSetPwm}]];
      window.__initialCpuTh = [[${cpuThreshold}]];
      window.__initialGpuTh = [[${gpuThreshold}]];
    </script>
    <script th:src="@{/js/fan.js(v=${#dates.createNow().getTime()})}"></script>
</section>
</body>
</html>
