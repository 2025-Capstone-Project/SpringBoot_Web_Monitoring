<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/default :: layout(~{::title}, ~{::section}) }">
<head>
    <title>Fan Control Dashboard</title>
</head>
<body>
<section id="fanSection" th:attr="data-initial-mode=${currentMode}, data-initial-set-pwm=${currentSetPwm}, data-initial-cpu-th=${cpuThreshold}, data-initial-gpu-th=${gpuThreshold}">
    <div class="card shadow-sm p-4">
        <h2 class="text-center mb-4">Fan Control Dashboard</h2>
        <div class="row g-3 kpi-grid">
            <div class="col-6 col-md-3">
                <div class="card kpi clickable-accordion" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseCpu" aria-expanded="false" aria-controls="collapseCpu" role="button" tabindex="0">
                    <div class="card-body text-center">
                        <div>
                            <div class="kpi-title">CPU Temperature</div>
                            <div class="kpi-value" id="cpuTemp">-- °C</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card kpi clickable-accordion" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseGpu" aria-expanded="false" aria-controls="collapseGpu" role="button" tabindex="0">
                    <div class="card-body text-center">
                        <div>
                            <div class="kpi-title">GPU Temperature</div>
                            <div class="kpi-value" id="gpuTemp">-- °C</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card kpi clickable-accordion" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseModel" aria-expanded="false" aria-controls="collapseModel" role="button" tabindex="0">
                    <div class="card-body text-center">
                        <div>
                            <div class="kpi-title">Model Result</div>
                            <div class="kpi-value" id="modelResult">--</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card kpi">
                    <div class="card-body text-center">
                        <div class="kpi-title">Set Fan PWM</div>
                        <div class="kpi-value" id="setPwm">-- %</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card kpi">
                    <div class="card-body text-center">
                        <div class="kpi-title">Actual Fan PWM</div>
                        <div class="kpi-value" id="actualPwm">-- %</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm p-4 mt-4">
        <h4 class="mb-3 text-center">Fan Control</h4>

        <!-- 상단 행: 왼쪽 드롭다운, 오른쪽 라디오 그룹 -->
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-6">
                <label for="controlMode" class="form-label mb-1">Control Mode:</label>
                <select id="controlMode" class="form-select"
                        th:disabled="${!isAdmin}"
                        th:title="${!isAdmin} ? '관리자만 변경할 수 있습니다' : '모드 선택'">
                    <option value="AUTOMATIC" th:selected="${currentMode} == 'AUTOMATIC'">Automatic</option>
                    <option value="MANUAL" th:selected="${currentMode} == 'MANUAL'">Manual</option>
                </select>
                <div class="form-text" th:if="${!isAdmin}">수동 제어는 관리자만 사용할 수 있습니다.</div>
                <div id="serverModeBadge" class="form-text"></div>
            </div>
            <div class="col-12 col-md-6" id="dimensionGroup">
                <div class="form-label mb-1">Control Target:</div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="dimension" id="dimSpeed" value="SPEED" checked>
                    <label class="form-check-label" for="dimSpeed">속도</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="dimension" id="dimTemp" value="TEMP">
                    <label class="form-check-label" for="dimTemp">온도</label>
                </div>
            </div>
        </div>

        <!-- 하단: 단일 위치에 두 컨트롤 영역을 토글 표시 -->
        <div class="row g-3 mt-1">
            <!-- 속도 제어 (Manual일 때만, 라디오=속도일 때) -->
            <div class="col-12" id="manualControlsSpeed" th:style="${currentMode} == 'MANUAL' ? '' : 'display:none;'">
                <fieldset th:disabled="${!isAdmin}">
                    <label for="pwmRange" class="form-label mb-1">Set PWM: <span id="pwmLabel" th:text="${currentSetPwm} + '%'">0%</span></label>
                    <input type="range" class="form-range" min="0" max="100" step="1" id="pwmRange" th:value="${currentSetPwm}"/>
                    <input type="number" class="form-control mt-2" id="pwmNumber" min="0" max="100" step="1" th:value="${currentSetPwm}" aria-label="Set PWM value"/>
                    <button id="applyBtn" class="btn btn-primary mt-2">Apply</button>
                </fieldset>
            </div>

            <!-- 온도 임계치 제어 (Manual + 라디오=온도) -->
            <div class="col-12" id="manualControlsTemp" style="display:none;">
                <fieldset th:disabled="${!isAdmin}">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label for="cpuThreshold" class="form-label">CPU 비정상 임계 (°C)</label>
                            <input type="range" class="form-range" min="30" max="100" step="1" id="cpuThreshold" th:value="${cpuThreshold}">
                            <input type="number" class="form-control" id="cpuThresholdNum" min="30" max="100" step="1" th:value="${cpuThreshold}" aria-label="CPU threshold value">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="gpuThreshold" class="form-label">GPU 비정상 임계 (°C)</label>
                            <input type="range" class="form-range" min="30" max="100" step="1" id="gpuThreshold" th:value="${gpuThreshold}">
                            <input type="number" class="form-control" id="gpuThresholdNum" min="30" max="100" step="1" th:value="${gpuThreshold}" aria-label="GPU threshold value">
                        </div>
                    </div>
                    <button id="applyTempBtn" class="btn btn-warning mt-2">Apply Thresholds</button>
                    <div class="form-text" th:if="${!isAdmin}">임계치는 관리자만 수정할 수 있습니다.</div>
                </fieldset>
            </div>
        </div>
    </div>

    <!-- Grafana accordion panels (lazy-loaded iframes) -->
    <div class="accordion mt-3" id="grafanaAccordion">
       <div class="accordion-item">
        <div id="collapseCpu" class="accordion-collapse collapse" data-bs-parent="#grafanaAccordion">
          <div class="accordion-body p-2">
            <iframe id="iframeCpu" src="http://34.50.29.59:3000/d-solo/admbwqw/new-dashboard?orgId=1&from=1763802527135&to=1763803490815&timezone=browser&refresh=auto&panelId=2&__feature.dashboardSceneSolo=true" width="100%" height="200" style="border:0"></iframe>
          </div>
        </div>
       </div>
       <div class="accordion-item">
        <div id="collapseGpu" class="accordion-collapse collapse" data-bs-parent="#grafanaAccordion">
          <div class="accordion-body p-2">
            <iframe id="iframeGpu" src="http://34.50.29.59:3000/d-solo/admbwqw/new-dashboard?orgId=1&from=1763802527135&to=1763803490815&timezone=browser&refresh=auto&panelId=panel-1&__feature.dashboardSceneSolo=true" width="100%" height="200" style="border:0"></iframe>
          </div>
        </div>
       </div>
       <div class="accordion-item">
        <div id="collapseModel" class="accordion-collapse collapse" data-bs-parent="#grafanaAccordion">
          <div class="accordion-body p-2">
            <iframe id="iframeModel" src="http://34.50.29.59:3000/d-solo/admbwqw/new-dashboard?orgId=1&from=1763802527135&to=1763803490815&timezone=browser&refresh=auto&panelId=3&__feature.dashboardSceneSolo=true" width="100%" height="200" style="border:0"></iframe>
          </div>
        </div>
       </div>
     </div>

    <!-- 초기값은 section[data-*]으로 전달됩니다 -->
    <!-- fan.js is loaded globally from layout/default after dependencies (Bootstrap, SockJS, STOMP) -->
 </section>
 </body>
 </html>
